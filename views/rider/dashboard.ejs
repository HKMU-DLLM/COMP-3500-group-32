<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Rider Dashboard</title>
		<link rel="stylesheet" href="styles.css" />
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
				background-color: #f9f9f9;
			}
			h1 {
				color: #333;
				text-align: center;
			}
			.header-container {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
			}
			.reward-button {
				background: #2196F3;
				color: white;
				border: none;
				padding: 10px 20px;
				cursor: pointer;
				border-radius: 5px;
				font-size: 16px;
				font-weight: bold;
			}
			.reward-button:hover {
				background: #0b7dda;
			}
			table {
				border-collapse: collapse;
				width: 100%;
				margin-top: 20px;
				background: #fff;
				border-radius: 10px;
				overflow: hidden;
				box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
			}
			th,
			td {
				border: 1px solid #ddd;
				padding: 10px;
				text-align: left;
			}
			th {
				background-color: #f0f0f0;
			}
			button {
				background: #4caf50;
				color: white;
				border: none;
				padding: 6px 12px;
				cursor: pointer;
				border-radius: 5px;
			}
			button:hover {
				background: #45a049;
			}
			.accepted {
				color: green;
				font-weight: bold;
				margin-top: 15px;
				text-align: center;
			}
			.modal {
				display: none;
				position: fixed;
				z-index: 1000;
				left: 0;
				top: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(0, 0, 0, 0.5);
			}
			.modal-content {
				background-color: white;
				margin: 15% auto;
				padding: 30px;
				border-radius: 10px;
				width: 300px;
				text-align: center;
				box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			}
			.modal-content h2 {
				margin-top: 0;
				color: #2196F3;
			}
			.modal-content p {
				font-size: 24px;
				font-weight: bold;
				color: #4caf50;
				margin: 20px 0;
			}
			.close-button {
				background: #f44336;
				color: white;
				border: none;
				padding: 8px 16px;
				cursor: pointer;
				border-radius: 5px;
				margin-top: 10px;
			}
			.close-button:hover {
				background: #da190b;
			}
		</style>
	</head>
	<body>
		<h1>üö¥ Rider Dashboard</h1>
		
		<div class="header-container">
			<p id="riderNameDisplay"></p>
			<button class="reward-button" onclick="showRewards()">üí∞ My Total Rewards</button>
		</div>

		<table id="ordersTable">
			<thead>
				<tr>
					<th>Order ID</th>
					<th>Restaurant Name</th>
					<th>Restaurant Address</th>
					<th>Order Items</th>
					<th>Customer Name</th>
					<th>Customer Address</th>
					<th>Distance(m)</th>
					<th>Order Time</th>
					<th>Rewards</th>
					<th>Action</th>
				</tr>
			</thead>
			<tbody>
				<% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %> <% if
				(!order.rider_name && order.restaurant_completed == 0) { %>
				<tr id="order-<%= order.id %>">
					<td><%= order.id %></td>
					<td><%= order.restaurant_name %></td>
					<td><%= order.restaurant_address %></td>
					<td><%= order.context || "N/A" %></td>
					<td><%= order.customer_name %></td>
					<td><%= order.customer_address %></td>
					<td><%= order.distance_m %></td>
					<td><%= order.created_at %></td>
					<td>$ <%= order.rewards %></td>
					<td><button onclick="acceptOrder('<%= order.id %>')">Accept</button></td>
				</tr>
				<% } %> <% }); %> <% } else { %>
				<tr>
					<td colspan="10" style="text-align: center">No available orders</td>
				</tr>
				<% } %>
			</tbody>
		</table>

		<p id="statusMessage" class="accepted"></p>

		<!-- Reward Modal -->
		<div id="rewardModal" class="modal">
			<div class="modal-content">
				<h2>üèÜ Total Rewards</h2>
				<p id="totalRewardAmount">$0.00</p>
				<button class="close-button" onclick="closeModal()">Close</button>
			</div>
		</div>

		<script>
			const riderName = "<%= riderNameIn%>";
			const totalRewards = <%= totalRewardsIn%>;
			
			document.getElementById("riderNameDisplay").innerText = `üëã Welcome, ${riderName}`;

			function showRewards() {
				document.getElementById("totalRewardAmount").innerText = `$${totalRewards.toFixed(2)}`;
				document.getElementById("rewardModal").style.display = "block";
			}

			function closeModal() {
				document.getElementById("rewardModal").style.display = "none";
			}

			// Close modal when clicking outside
			window.onclick = function(event) {
				const modal = document.getElementById("rewardModal");
				if (event.target == modal) {
					closeModal();
				}
			}

			async function acceptOrder(orderId) {
				const confirmAccept = confirm("Confirm to accept this order?");
				if (!confirmAccept) return;

				try {
					const res = await fetch(
						`/rider/accept/${orderId}`,
						{
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ rider_name: riderName }),
						}
					);

					let data = null;
					try {
						data = await res.json();
					} catch {
						throw new Error("Invalid JSON response from server");
					}

					if (!res.ok) {
						// ‚úÖ Show server error message if available
						alert(data?.error || "‚ùå Failed to accept order");
						return;
					}

					// ‚úÖ Redirect on success
					if (data.redirect) {
						window.location.href = data.redirect;
					} else {
						alert("‚ùå No redirect URL provided by server");
					}
				} catch (err) {
					console.error(err);
					alert("‚ö†Ô∏è Error connecting to server");
				}
			}
		</script>
	</body>
</html>