<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title><%= riderName %>'s Delivery History</title>
		<link rel="stylesheet" href="/styles.css" />
		<style>
			body {
				font-family: Arial, sans-serif;
				padding: 20px;
				background-color: #f9f9f9;
			}
			h1 {
				color: #333;
				text-align: center;
			}
			table {
				border-collapse: collapse;
				width: 100%;
				margin-top: 20px;
				background: #fff;
				border-radius: 10px;
				overflow: hidden;
				box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
			}
			th,
			td {
				border: 1px solid #ddd;
				padding: 10px;
				text-align: left;
			}
			th {
				background-color: #f0f0f0;
			}
			button {
				background: #4caf50;
				color: white;
				border: none;
				padding: 6px 12px;
				cursor: pointer;
				border-radius: 5px;
				margin-bottom: 10px;
			}
			button:hover {
				background: #45a049;
			}
			button:disabled {
				background: #bfbfbf; /* light grey */
				cursor: not-allowed;
				opacity: 0.6;
			}
			button:disabled:hover {
				background: #bfbfbf;
			}

			.distanceSlider {
				width: 100%;
				appearance: none;
				height: 6px;
				border-radius: 5px;
				background: #ddd;
				outline: none;
			}

			.distanceSlider::-webkit-slider-thumb {
				appearance: none;
				width: 18px;
				height: 18px;
				background: #4caf50;
				border-radius: 50%;
				cursor: pointer;
			}
			.distanceSlider {
				background: linear-gradient(
					to right,
					#4caf50 calc(var(--value-percent) * 1%),
					#ddd 0
				);
			}
		</style>
	</head>
	<body>
		<h1>ðŸ“œ <%= riderName %>'s Delivery History</h1>
		<div style="text-align: center"></div>

		<table>
			<thead>
				<tr>
					<th>Order ID</th>
					<th>Restaurant Name</th>
					<th>Restaurant Address</th>
					<th>Customer Name</th>
					<th>Customer Address</th>
					<th>Context</th>
					<th>Order Time</th>
					<th>Rewards</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><%= order.id %></td>
					<td><%= order.restaurant_name %></td>
					<td><%= order.restaurant_address %></td>
					<td><%= order.customer_name %></td>
					<td><%= order.customer_address %></td>
					<td><%= order.context %></td>
					<td><%= order.created_at %></td>
					<td>$ <%= order.rewards %></td>
				</tr>
			</tbody>
		</table>
		<form>
			<h3>Remaining Distance to Customer:</h3>
			<div class="slidecontainer">
				<input
					type="range"
					id="distanceSlider"
					min="0"
					max="<%= order.distance_m %>"
					step="1"
					value="<%= order.distance_m - order.remaining_distance %>"
					class="distanceSlider" />
			</div>
			<div style="text-align: center">
				<label for="distanceSlider" id="distance_label"
					>Remaining distance: <%= order.remaining_distance %> m</label
				>
				<br />
				<button type="button" onclick="SendDistance()">Send distance</button>
				<button type="button" onclick="MarkAsDelivered()" id="complete_button">Mark as Delivered</button>
			</div>
		</form>
		<div id="deliveredPopup" 
			style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
			<div style="background:white; padding:20px; border-radius:8px; text-align:center;">
				<h3>Order Delivered Successfully!</h3>
				<button id="confirmDeliveredBtn"
					style="margin-top:15px; padding:8px 16px; cursor:pointer;">
					Confirm
				</button>
			</div>
		</div>
	</body>
	<script>
		const remaining = <%= order.remaining_distance %>;
		const slider = document.getElementById('distanceSlider');
		const max = parseFloat(slider.max);
		function updateFill() {
			const min = parseFloat(slider.min);
			const value = parseFloat(slider.value);
			const percent = ((value - min) / (max - min)) * 100;

			slider.style.setProperty("--value-percent", percent);
			document.getElementById("distance_label").innerText = `Remaining distance: ${max-value} m`;
			if (value >= max) {
				document.getElementById("complete_button").disabled = false;
			}else{
				document.getElementById("complete_button").disabled = true;
			}
		}
		function SendDistance() {
			const newRemaining = max - parseFloat(slider.value);
			fetch(`/rider/update-distance/<%= order.id %>`, {
				method: 'POST',
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ remaining_distance: newRemaining })

			})
			.then(response => {
				if (response.ok) {
					alert('Distance updated successfully!');
				} else {
					alert('Failed to update distance.');
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('Error updating distance.');
			});
		}

		function MarkAsDelivered() {
			fetch(`/rider/mark-delivered/<%= order.id %>`, {
				method: 'POST'
				
			})
			.then(response => {
				if (response.ok) {
					showDeliveredPopup();
				} else {
					alert('Failed to mark order as delivered.');
				}
			})
			.catch(error => {
				console.error('Error:', error);
				alert('Error marking order as delivered.');
			});
		}
		function showDeliveredPopup() {
			const popup = document.getElementById('deliveredPopup');
			const confirmBtn = document.getElementById('confirmDeliveredBtn');

			popup.style.display = 'flex';

			confirmBtn.onclick = () => {
				window.location.href = '/rider';
			};
		}
		slider.addEventListener('input', updateFill);
		updateFill();
	</script>
</html>
