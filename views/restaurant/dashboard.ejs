<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title><%= restaurant.name %> Dashboard</title>
	</head>
	<body>
		<h1><%= restaurant.name %> Menu Dashboard</h1>
		<p>Cuisine: <%= restaurant.cuisine_type %></p>

		<h2>Menu Items</h2>
		<% if (menus && menus.length > 0) { %>
		<table border="1" cellpadding="8" cellspacing="0">
			<thead>
				<tr>
					<th>Dish Name</th>
					<th>Price</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				<% menus.forEach(menu => { %>
				<tr>
					<td><%= menu.dish_name %></td>
					<td>$<%= menu.price.toFixed(2) %></td>
					<td>
						<form
							action="/restaurant/menu/edit/<%= menu.id %>"
							method="get"
							style="display: inline">
							<button type="submit">Edit</button>
						</form>
						<form
							action="/restaurant/menu/delete/<%= menu.id %>"
							method="post"
							style="display: inline">
							<button type="submit">Delete</button>
						</form>
					</td>
				</tr>
				<% }) %>
			</tbody>
		</table>
		<% } else { %>
		<p>No menu items yet.</p>
		<% } %>

		<hr />
		<h2>Add New Menu Item</h2>
		<form action="/restaurant/menu/new" method="post">
			<input type="hidden" name="restaurant" value="<%= restaurant.name %>" />
			<label>Dish Name: <input type="text" name="dish_name" required /></label><br />
			<label>Price: <input type="number" name="price" step="0.01" required /></label><br />
			<button type="submit">Add</button>
		</form>

		<!-- ===== ORDERS SECTION ===== -->
		<h2>Orders</h2>
		<table border="1" cellpadding="8" cellspacing="0">
			<thead>
				<tr>
					<th>Order ID</th>
					<th>Customer</th>
					<th>Address</th>
					<th>Created At</th>
					<th>Rider</th>
					<th>Items</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody id="orders-body">
				<% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %>
				<tr>
					<td><%= order.id %></td>
					<td><%= order.customer_name || '-' %></td>
					<td><%= order.customer_address %></td>
					<td><%= order.created_at %></td>
					<td><%= order.rider_name || '-' %></td>
					<td><%= order.context %></td>
					<td>
						<% if (!order.restaurant_completed) { %>
						<form
							action="/restaurant/complete/<%= order.id %>"
							method="post"
							style="display: inline">
							<input type="hidden" name="restaurant" value="<%= restaurant.name %>" />
							<button type="submit">Mark as Completed</button>
						</form>
						<% } %>
					</td>
				</tr>
				<% }) %> <% } else { %>
				<tr>
					<td colspan="7">No orders yet.</td>
				</tr>
				<% } %>
			</tbody>
		</table>

		<!-- Socket.io must be loaded BEFORE your script -->
		<script src="/socket.io/socket.io.js"></script>
		<script>
			if (typeof io !== "undefined") {
				const socket = io();
				const restaurantName = "<%= restaurant.name %>";

				// Listen for new orders from server
				socket.on("newOrder", (data) => {
					if (data.restaurantName === restaurantName) {
						fetchOrders();
					}
				});

				// Fetch and update order list
				async function fetchOrders() {
					try {
						const response = await fetch(
							`/restaurant/orders?name=${encodeURIComponent(restaurantName)}`
						);

						if (!response.ok) return;

						const orders = await response.json();
						const tbody = document.querySelector("#orders-body");
						tbody.innerHTML = "";

						if (orders.length === 0) {
							tbody.innerHTML = "<tr><td colspan='7'>No orders yet.</td></tr>";
							return;
						}

						orders.forEach((order) => {
							const row = document.createElement("tr");
							row.innerHTML = `
						<td>${order.id}</td>
						<td>${order.customer_name || "-"}</td>
						<td>${order.customer_address}</td>
						<td>${order.created_at}</td>
						<td>${order.rider_name || "-"}</td>
						<td>${order.context}</td>
						<td>
							${
								order.restaurant_completed
									? ""
									: `
									<form action="/restaurant/complete/${order.id}" method="post" style="display:inline">
										<input type="hidden" name="restaurant" value="${restaurantName}" />
										<button type="submit">Mark as Completed</button>
									</form>`
							}
						</td>
					`;
							tbody.appendChild(row);
						});
					} catch (err) {
						// silently ignore errors
					}
				}

				// Initial load
				fetchOrders();
			}
		</script>
	</body>
</html>
